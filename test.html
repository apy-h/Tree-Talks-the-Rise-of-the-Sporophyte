<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tree Talks: the Rise of the Sporophyte</title>
  <style>
    /* Basic styling for the whole page */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      overflow: hidden; /* Prevent page scrolling */
    }

    /* Container for the tree */
    #tree-container {
      width: 100vw;
      height: 100vh;
      background-color: #fafafa;
    }

    /* Tooltip styling */
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-size: 14px;
    }

    /* Styling for nodes, links, and tick marks */
    .node-circle {
      fill: steelblue;
      stroke: #fff;
      stroke-width: 1.5px;
      cursor: pointer;
    }

    .link {
      fill: none;
      stroke: #999;
      stroke-width: 2px;
    }

    .tick-mark {
      fill: tomato;
      stroke: tomato;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="tree-container"></div>

  <!-- D3.js library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // Sample hierarchical data for the tree
    const treeData = {
      name: "Root",
      traits: [],
      children: [
        {
          name: "Green Algae",
          traits: [{ label: "Trait 1", info: "TBD 1"}],
          children: [
            {
              name: "Chara and Nitella",
              traits: [{ label: "Trait 2", info: "TBD 2"}]
            },
            {
              name: "Choleochaete",
              traits: [{ label: "Trait 3", info: "TBD 3"}]
            },
            {
              name: "Zygnemetales",
              traits: [{ label: "Trait 4", info: "TBD 4"}]
            }
          ]
        },
        {
          name: "Group A",
          traits: [{ label: "Trait A", info: "General trait for Group A." }],
          children: [
            {
              name: "A1",
              traits: [{ label: "Trait A1", info: "Sub-trait for A1." }],
              children: []
            },
            {
              name: "A2",
              traits: [{ label: "Trait A2", info: "Sub-trait for A2." }],
              children: []
            }
          ]
        },
        {
          name: "Group B",
          traits: [{ label: "Trait B", info: "General trait for Group B." }],
          children: [
            {
              name: "B1",
              traits: [{ label: "Trait B1", info: "Sub-trait for B1." }],
              children: []
            },
            {
              name: "B2",
              traits: [{ label: "Trait B2", info: "Sub-trait for B2." }],
              children: []
            },
            {
              name: "B3",
              traits: [{ label: "Trait B3", info: "Sub-trait for B3." }],
              children: []
            }
          ]
        }
      ]
    };

/*
const treeData = {
  name: "Root",
  traits: [],
  children: [
    {
      name: "Ext.",
      traits: [{ label: "Extinct Group", info: "This represents an extinct lineage." }],
      children: []
    },
    {
      name: "Group W",
      traits: [],
      children: [
        {
          name: "Chara and Nitella",
          traits: [{ label: "Charophytes", info: "Freshwater green algae, close relatives of land plants." }],
          children: []
        },
        {
          name: "Group W",
          traits: [],
          children: [
            {
              name: "Choleochaete",
              traits: [{ label: "Disk-shaped Algae", info: "A green alga with a growth pattern similar to land plants." }],
              children: []
            },
            {
              name: "Group W",
              traits: [],
              children: [
                {
                  name: "Zygnemetales",
                  traits: [{ label: "Closest Algal Relatives", info: "Unicellular and filamentous green algae, sister to land plants." }],
                  children: []
                },
                {
                  name: "Group for Land Plants",
                  traits: [{ label: "Embryophytes", info: "Includes all land plants." }],
                  children: [
                    {
                      name: "Gymnosperms",
                      traits: [{ label: "Seed Plants", info: "Non-flowering seed-producing plants like conifers." }],
                      children: []
                    },
                    {
                      name: "Angiosperms",
                      traits: [{ label: "Flowering Plants", info: "Plants that produce flowers and fruits." }],
                      children: []
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
};
*/

    // Get container dimensions
    const width = window.innerWidth;
    const height = window.innerHeight;

    // Create a tooltip div that will be used to display information on hover
    const tooltip = d3.select("body")
      .append("div")
      .attr("class", "tooltip");

    // Create an SVG element inside the container
    const svg = d3.select("#tree-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .style("cursor", "move");

    // Create a group (<g>) that will hold the tree and be subject to pan/zoom transformations
    const container = svg.append("g");

    // Define zoom behavior: you can pan (drag) and zoom (wheel or pinch)
    const zoomBehavior = d3.zoom()
      .scaleExtent([0.8, 1.6])  // Customize the minimum and maximum zoom
      .on("zoom", (event) => {
        container.attr("transform", event.transform);
      });

    svg.call(zoomBehavior);

    // Create a tree layout (adjust size as needed)
    const treeLayout = d3.tree().size([height - 100, width - 200]);

    // Convert the data into a hierarchy structure
    const root = d3.hierarchy(treeData);

    // Generate tree layout (node positions)
    treeLayout(root);

    // Create links (branches) connecting the nodes
    container.selectAll(".link")
      .data(root.links())
      .enter()
      .append("path")
      .attr("class", "link")
      .attr("d", d3.linkHorizontal()
        .x(d => d.y)
        .y(d => d.x)
      );

    // Create nodes as groups so we can attach both a circle and text
    const node = container.selectAll(".node")
      .data(root.descendants())
      .enter()
      .append("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.y},${d.x})`);

    // Draw node circles
    node.append("circle")
      .attr("class", "node-circle")
      .attr("r", 6)
      .on("click", (event, d) => {
        // You can customize node click behavior here (e.g., expand/collapse or show info)
        alert(`Node clicked: ${d.data.name}`);
      });

    // Add text labels to nodes
    node.append("text")
      .attr("dy", -10)
      .attr("text-anchor", "middle")
      .text(d => d.data.name);

    // Create trait tick marks along each link that has traits.
    const linksWithTraits = root.links().filter(d => d.target.data.traits && d.target.data.traits.length > 0);

    linksWithTraits.forEach(linkData => {
      const traits = linkData.target.data.traits;
      const sourceX = linkData.source.x;
      const sourceY = linkData.source.y;
      const targetX = linkData.target.x;
      const targetY = linkData.target.y;

      // Calculate the vector between source and target
      const dx = targetX - sourceX;
      const dy = targetY - sourceY;

      // Distribute tick marks evenly along the branch
      traits.forEach((trait, i) => {
        const fraction = (i + 1) / (traits.length + 1);
        const tx = sourceY + dy ? (dy * fraction) : (dx * fraction); // this fallback is rarely needed
        const ty = sourceX + dx ? (dx * fraction) : (dy * fraction);
        // For clarity, we calculate positions using linear interpolation.
        const interpX = sourceY + (targetY - sourceY) * fraction;
        const interpY = sourceX + (targetX - sourceX) * fraction;

        container.append("circle")
          .attr("class", "tick-mark")
          .attr("r", 4)
          .attr("cx", interpX)
          .attr("cy", interpY)
          .on("mouseover", (event) => {
            tooltip.style("opacity", 1)
              .html(`<strong>${trait.label}</strong><br/>${trait.info || ""}`);
          })
          .on("mousemove", (event) => {
            tooltip.style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY + 10) + "px");
          })
          .on("mouseout", () => {
            tooltip.style("opacity", 0);
          })
          .on("click", () => {
            alert(`${trait.label}\n\n${trait.info}`);
          });
      });
    });
  </script>
</body>
</html>